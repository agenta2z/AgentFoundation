<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Agent System &#8212; OpenManus 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=12dfc556" />
    <script src="_static/documentation_options.js?v=01f34227"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Orchestration Flow" href="orchestration_flow.html" />
    <link rel="prev" title="System Architecture" href="architecture.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="agent-system">
<h1>Agent System<a class="headerlink" href="#agent-system" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#class-hierarchy" id="id3">Class Hierarchy</a></p></li>
<li><p><a class="reference internal" href="#baseagent" id="id4">BaseAgent</a></p>
<ul>
<li><p><a class="reference internal" href="#state-machine" id="id5">State Machine</a></p></li>
<li><p><a class="reference internal" href="#key-attributes" id="id6">Key Attributes</a></p></li>
<li><p><a class="reference internal" href="#execution-loop" id="id7">Execution Loop</a></p></li>
<li><p><a class="reference internal" href="#stuck-detection" id="id8">Stuck Detection</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#reactagent" id="id9">ReActAgent</a></p></li>
<li><p><a class="reference internal" href="#toolcallagent" id="id10">ToolCallAgent</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id11">Key Attributes</a></p></li>
<li><p><a class="reference internal" href="#think-phase" id="id12">Think Phase</a></p></li>
<li><p><a class="reference internal" href="#act-phase" id="id13">Act Phase</a></p></li>
<li><p><a class="reference internal" href="#tool-execution" id="id14">Tool Execution</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#manus-agent" id="id15">Manus Agent</a></p>
<ul>
<li><p><a class="reference internal" href="#configuration" id="id16">Configuration</a></p></li>
<li><p><a class="reference internal" href="#tools" id="id17">Tools</a></p></li>
<li><p><a class="reference internal" href="#async-factory-pattern" id="id18">Async Factory Pattern</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#browseragent" id="id19">BrowserAgent</a></p></li>
<li><p><a class="reference internal" href="#sweagent" id="id20">SWEAgent</a></p></li>
<li><p><a class="reference internal" href="#mcpagent" id="id21">MCPAgent</a></p></li>
<li><p><a class="reference internal" href="#dataanalysis-agent" id="id22">DataAnalysis Agent</a></p></li>
<li><p><a class="reference internal" href="#sandboxmanus-agent" id="id23">SandboxManus Agent</a></p></li>
<li><p><a class="reference internal" href="#agent-lifecycle" id="id24">Agent Lifecycle</a></p>
<ul>
<li><p><a class="reference internal" href="#creation" id="id25">Creation</a></p></li>
<li><p><a class="reference internal" href="#execution" id="id26">Execution</a></p></li>
<li><p><a class="reference internal" href="#cleanup" id="id27">Cleanup</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#memory-system" id="id28">Memory System</a></p>
<ul>
<li><p><a class="reference internal" href="#message-types" id="id29">Message Types</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The OpenManus agent system implements a hierarchical class structure based
on the <strong>ReAct (Reason + Act)</strong> paradigm. Agents iteratively reason about
their task by calling an LLM, then act by executing tools, observing
results, and repeating until the task is complete or a step limit is
reached.</p>
</section>
<section id="class-hierarchy">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Class Hierarchy</a><a class="headerlink" href="#class-hierarchy" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>BaseAgent (abstract)
│   Manages: state machine, memory, step loop, stuck detection
│
└── ReActAgent (abstract)
    │   Adds: think() + act() decomposition
    │
    └── ToolCallAgent (concrete)
        │   Implements: LLM function calling, tool execution
        │
        ├── Manus
        │     General-purpose agent with MCP support
        │
        ├── BrowserAgent
        │     Browser-focused with context helper
        │
        ├── SWEAgent
        │     Software engineering (bash + file editing)
        │
        ├── MCPAgent
        │     Dynamic MCP server tool discovery
        │
        ├── DataAnalysis
        │     Data analysis + chart visualization
        │
        └── SandboxManus
              Cloud sandbox with VNC and remote tools
</pre></div>
</div>
</section>
<section id="baseagent">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">BaseAgent</a><a class="headerlink" href="#baseagent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/base.py</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">BaseAgent</span></code> is the abstract foundation for all agents. It manages
the agent lifecycle, state machine, memory, and execution loop.</p>
<section id="state-machine">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">State Machine</a><a class="headerlink" href="#state-machine" title="Link to this heading">¶</a></h3>
<p>Agents transition through four states defined by the <code class="docutils literal notranslate"><span class="pre">AgentState</span></code> enum:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>IDLE ──► RUNNING ──► FINISHED
            │
            └──────► ERROR
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 15.0%" />
<col style="width: 85.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>State</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">IDLE</span></code></p></td>
<td><p>Initial state. Agent is created but not yet running.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RUNNING</span></code></p></td>
<td><p>Agent is actively executing steps (think + act loop).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">FINISHED</span></code></p></td>
<td><p>Agent has completed its task (via <code class="docutils literal notranslate"><span class="pre">Terminate</span></code> tool or manual
state set).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ERROR</span></code></p></td>
<td><p>An unrecoverable error occurred during execution.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="key-attributes">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Key Attributes</a><a class="headerlink" href="#key-attributes" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 15.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">name</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p>Agent identifier (default: <code class="docutils literal notranslate"><span class="pre">&quot;base&quot;</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">description</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p>Human-readable description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">system_prompt</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p>System message sent to LLM on every call</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">next_step_prompt</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p>Appended as user message before each <code class="docutils literal notranslate"><span class="pre">think()</span></code> call</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">memory</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Memory</span></code></p></td>
<td><p>Conversation history (bounded list of <code class="docutils literal notranslate"><span class="pre">Message</span></code> objects)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">state</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AgentState</span></code></p></td>
<td><p>Current state in the state machine</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">max_steps</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Maximum steps before forced termination (default: 10)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">current_step</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Counter for the current step number</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">duplicate_threshold</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Number of identical messages before stuck detection (default: 2)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">llm</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LLM</span></code></p></td>
<td><p>LLM client instance</p></td>
</tr>
</tbody>
</table>
</section>
<section id="execution-loop">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Execution Loop</a><a class="headerlink" href="#execution-loop" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method implements the main execution loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># 1. Validate and transition to RUNNING state</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">AgentState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Agent not in IDLE state&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">AgentState</span><span class="o">.</span><span class="n">RUNNING</span>

    <span class="c1"># 2. Add user request to memory</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_memory</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="c1"># 3. Execute step loop</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span>
           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">AgentState</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_result</span><span class="p">)</span>

    <span class="c1"># 4. Handle step limit exceeded</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">AgentState</span><span class="o">.</span><span class="n">IDLE</span>

    <span class="c1"># 5. Return result</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="stuck-detection">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Stuck Detection</a><a class="headerlink" href="#stuck-detection" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">is_stuck()</span></code> method detects when an agent is repeating the same
response. It counts how many previous assistant messages have content
identical to the latest message across the entire conversation history.
If the count reaches <code class="docutils literal notranslate"><span class="pre">duplicate_threshold</span></code> (default 2), it returns
<code class="docutils literal notranslate"><span class="pre">True</span></code> and the <code class="docutils literal notranslate"><span class="pre">handle_stuck_state()</span></code> method prepends a
strategy-change prompt to <code class="docutils literal notranslate"><span class="pre">next_step_prompt</span></code>.</p>
<p>This is a critical safety mechanism against infinite loops where the LLM
keeps producing the same output.</p>
</section>
</section>
<section id="reactagent">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">ReActAgent</a><a class="headerlink" href="#reactagent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/react.py</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">ReActAgent</span></code> adds the <strong>think-then-act</strong> decomposition to the base
agent. It is still abstract – subclasses must implement both <code class="docutils literal notranslate"><span class="pre">think()</span></code>
and <code class="docutils literal notranslate"><span class="pre">act()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ReActAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">think</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process current state and decide next action.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute decided actions.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">should_act</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">think</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_act</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Thinking complete - no action needed&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">think()</span></code> method returns a boolean: <code class="docutils literal notranslate"><span class="pre">True</span></code> if the agent decided
on actions to take, <code class="docutils literal notranslate"><span class="pre">False</span></code> if thinking is complete without needing
action (e.g., the LLM returned a text response with no tool calls).</p>
</section>
<section id="toolcallagent">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">ToolCallAgent</a><a class="headerlink" href="#toolcallagent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/toolcall.py</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">ToolCallAgent</span></code> is the first concrete agent class. It implements
the ReAct pattern using <strong>LLM function calling</strong> (OpenAI tool_calls API).</p>
<section id="id1">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Key Attributes</a><a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 15.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">available_tools</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ToolCollection</span></code></p></td>
<td><p>Registry of tools the agent can use</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tool_calls</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[ToolCall]</span></code></p></td>
<td><p>Tool calls from the last LLM response</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tool_choices</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ToolChoice</span></code></p></td>
<td><p>How the LLM selects tools: <code class="docutils literal notranslate"><span class="pre">NONE</span></code>, <code class="docutils literal notranslate"><span class="pre">AUTO</span></code>, <code class="docutils literal notranslate"><span class="pre">REQUIRED</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">special_tool_names</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[str]</span></code></p></td>
<td><p>Tools that trigger state changes (default: <code class="docutils literal notranslate"><span class="pre">[&quot;terminate&quot;]</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">max_steps</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Override: 30 (higher than BaseAgent’s 10)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">max_observe</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Maximum characters in tool output before truncation</p></td>
</tr>
</tbody>
</table>
</section>
<section id="think-phase">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Think Phase</a><a class="headerlink" href="#think-phase" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">think()</span></code> method:</p>
<ol class="arabic simple">
<li><p>Appends <code class="docutils literal notranslate"><span class="pre">next_step_prompt</span></code> as a user message to memory</p></li>
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">self.llm.ask_tool()</span></code> with:
- Full message history (<code class="docutils literal notranslate"><span class="pre">self.memory.messages</span></code>)
- System prompt
- Available tool schemas (<code class="docutils literal notranslate"><span class="pre">self.available_tools.to_params()</span></code>)
- Tool choice mode</p></li>
<li><p>Parses the LLM response:
- If <code class="docutils literal notranslate"><span class="pre">tool_calls</span></code> present → stores them, returns <code class="docutils literal notranslate"><span class="pre">True</span></code>
- If text-only response → adds to memory, returns <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
</ol>
</section>
<section id="act-phase">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Act Phase</a><a class="headerlink" href="#act-phase" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">act()</span></code> method:</p>
<ol class="arabic simple">
<li><p>Iterates over <code class="docutils literal notranslate"><span class="pre">self.tool_calls</span></code></p></li>
<li><p>For each tool call:
a. Parses JSON arguments from <code class="docutils literal notranslate"><span class="pre">tool_call.function.arguments</span></code>
b. Calls <code class="docutils literal notranslate"><span class="pre">self.execute_tool(tool_call)</span></code>
c. Handles special tools (terminate → <code class="docutils literal notranslate"><span class="pre">AgentState.FINISHED</span></code>)
d. Truncates result to <code class="docutils literal notranslate"><span class="pre">max_observe</span></code> characters if set
e. Adds result as <code class="docutils literal notranslate"><span class="pre">Message.tool_message()</span></code> to memory</p></li>
<li><p>Returns concatenated results</p></li>
</ol>
</section>
<section id="tool-execution">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Tool Execution</a><a class="headerlink" href="#tool-execution" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_tools</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tool_input</span><span class="o">=</span><span class="n">args</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="manus-agent">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Manus Agent</a><a class="headerlink" href="#manus-agent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/manus.py</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">Manus</span></code> agent is the <strong>flagship general-purpose agent</strong>. It combines
multiple tools with MCP server integration for maximum versatility.</p>
<section id="configuration">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Configuration</a><a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 29.4%" />
<col style="width: 70.6%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">name</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;manus&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">max_steps</span></code></p></td>
<td><p>20</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">system_prompt</span></code></p></td>
<td><p>From <code class="docutils literal notranslate"><span class="pre">app/prompt/manus.py</span></code> – identity + workspace directory</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">next_step_prompt</span></code></p></td>
<td><p>Tool selection guidance with current directory context</p></td>
</tr>
</tbody>
</table>
</section>
<section id="tools">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Tools</a><a class="headerlink" href="#tools" title="Link to this heading">¶</a></h3>
<p>Default tools (statically configured):</p>
<ol class="arabic simple">
<li><p><strong>PythonExecute</strong> – Execute Python code</p></li>
<li><p><strong>BrowserUseTool</strong> – Browser automation (16 actions)</p></li>
<li><p><strong>StrReplaceEditor</strong> – File viewing and editing</p></li>
<li><p><strong>AskHuman</strong> – Request human input</p></li>
<li><p><strong>Terminate</strong> – Signal task completion</p></li>
</ol>
<p>Plus any <strong>MCP server tools</strong> discovered at initialization from the
<code class="docutils literal notranslate"><span class="pre">[mcp]</span></code> configuration section.</p>
</section>
<section id="async-factory-pattern">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Async Factory Pattern</a><a class="headerlink" href="#async-factory-pattern" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Manus</span></code> agent uses an async factory method because MCP connection
setup is asynchronous:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Manus&quot;</span><span class="p">:</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Connect to MCP servers from config</span>
    <span class="n">mcp_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">mcp</span>
    <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">mcp_config</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">instance</span><span class="o">.</span><span class="n">mcp_clients</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">available_tools</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="o">*</span><span class="n">instance</span><span class="o">.</span><span class="n">mcp_clients</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span>
</pre></div>
</div>
</section>
</section>
<section id="browseragent">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">BrowserAgent</a><a class="headerlink" href="#browseragent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/browser.py</span></code></p>
<p>Specialized for browser automation tasks. Uses a <code class="docutils literal notranslate"><span class="pre">BrowserContextHelper</span></code>
to capture and format browser state (URL, tabs, scroll position,
screenshot) as context for each LLM call.</p>
<p>Key Features:</p>
<ul class="simple">
<li><p>94-line system prompt with detailed JSON response format</p></li>
<li><p>Browser state tracking (current URL, open tabs, scroll position)</p></li>
<li><p>Screenshot-based visual context for multimodal LLM reasoning</p></li>
<li><p>Memory tracking field in structured responses</p></li>
</ul>
</section>
<section id="sweagent">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">SWEAgent</a><a class="headerlink" href="#sweagent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/swe.py</span></code></p>
<p>Software engineering agent with tools for shell commands and file editing:</p>
<ul class="simple">
<li><p><strong>Bash</strong> – Persistent shell session</p></li>
<li><p><strong>StrReplaceEditor</strong> – File viewing and editing with undo</p></li>
<li><p><strong>Terminate</strong> – Task completion</p></li>
</ul>
<p>System prompt describes the file editor interface, response format
requirements, and indentation handling.</p>
</section>
<section id="mcpagent">
<h2><a class="toc-backref" href="#id21" role="doc-backlink">MCPAgent</a><a class="headerlink" href="#mcpagent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/mcp.py</span></code></p>
<p>Connects to MCP servers for dynamic tool discovery:</p>
<ul class="simple">
<li><p>Tools are discovered at connection time from external MCP servers</p></li>
<li><p>Periodic tool refresh every <code class="docutils literal notranslate"><span class="pre">_refresh_tools_interval</span></code> steps (default: 5)</p></li>
<li><p>Handles multimedia responses (base64 images)</p></li>
<li><p>Graceful shutdown when MCP service becomes unavailable</p></li>
<li><p>Supports both SSE and stdio transport protocols</p></li>
</ul>
</section>
<section id="dataanalysis-agent">
<h2><a class="toc-backref" href="#id22" role="doc-backlink">DataAnalysis Agent</a><a class="headerlink" href="#dataanalysis-agent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/data_analysis.py</span></code></p>
<p>Specialized for data analysis and visualization:</p>
<ul class="simple">
<li><p><strong>NormalPythonExecute</strong> – Extended Python execution with code_type</p></li>
<li><p><strong>VisualizationPrepare</strong> – Prepare metadata for chart generation</p></li>
<li><p><strong>DataVisualization</strong> – Create charts from CSV using VMind</p></li>
<li><p><strong>Terminate</strong> – Task completion</p></li>
</ul>
<p>Uses a visualization-specific system prompt that requires analysis
reports.</p>
</section>
<section id="sandboxmanus-agent">
<h2><a class="toc-backref" href="#id23" role="doc-backlink">SandboxManus Agent</a><a class="headerlink" href="#sandboxmanus-agent" title="Link to this heading">¶</a></h2>
<p><strong>File</strong>: <code class="docutils literal notranslate"><span class="pre">app/agent/sandbox_agent.py</span></code></p>
<p>Cloud sandbox variant of <code class="docutils literal notranslate"><span class="pre">Manus</span></code> using Daytona:</p>
<ul class="simple">
<li><p>Runs in isolated cloud environments with VNC</p></li>
<li><p>Tools: <code class="docutils literal notranslate"><span class="pre">SandboxBrowserTool</span></code>, <code class="docutils literal notranslate"><span class="pre">SandboxFilesTool</span></code>,
<code class="docutils literal notranslate"><span class="pre">SandboxShellTool</span></code>, <code class="docutils literal notranslate"><span class="pre">SandboxVisionTool</span></code></p></li>
<li><p>Also supports MCP tools and human interaction</p></li>
<li><p>Resource limits: 2 CPU, 4GB RAM, 5GB disk</p></li>
<li><p>Auto-stop after 15 minutes of inactivity</p></li>
</ul>
</section>
<section id="agent-lifecycle">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">Agent Lifecycle</a><a class="headerlink" href="#agent-lifecycle" title="Link to this heading">¶</a></h2>
<section id="creation">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Creation</a><a class="headerlink" href="#creation" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Instantiation</strong>: Agent class is created (Pydantic model init)</p></li>
<li><p><strong>Configuration</strong>: System prompt, tools, LLM instance are configured</p></li>
<li><p><strong>MCP Connection</strong> (if applicable): <code class="docutils literal notranslate"><span class="pre">create()</span></code> factory connects to
MCP servers</p></li>
</ol>
</section>
<section id="execution">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Execution</a><a class="headerlink" href="#execution" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>``run(prompt)``</strong>: Entry point, transitions to RUNNING state</p></li>
<li><p><strong>Step Loop</strong>: Iterates <code class="docutils literal notranslate"><span class="pre">think()</span></code> → <code class="docutils literal notranslate"><span class="pre">act()</span></code> up to <code class="docutils literal notranslate"><span class="pre">max_steps</span></code></p></li>
<li><p><strong>Termination</strong>: Via <code class="docutils literal notranslate"><span class="pre">Terminate</span></code> tool, max_steps, or error</p></li>
</ol>
</section>
<section id="cleanup">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Cleanup</a><a class="headerlink" href="#cleanup" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>``cleanup()``</strong>: Called in <code class="docutils literal notranslate"><span class="pre">finally</span></code> block after <code class="docutils literal notranslate"><span class="pre">run()</span></code></p></li>
<li><p><strong>Browser cleanup</strong>: Closes browser contexts and connections</p></li>
<li><p><strong>MCP disconnect</strong>: Closes all MCP server connections</p></li>
<li><p><strong>Sandbox cleanup</strong>: Stops and removes Docker containers</p></li>
</ol>
</section>
</section>
<section id="memory-system">
<h2><a class="toc-backref" href="#id28" role="doc-backlink">Memory System</a><a class="headerlink" href="#memory-system" title="Link to this heading">¶</a></h2>
<p>Each agent has its own <code class="docutils literal notranslate"><span class="pre">Memory</span></code> instance (defined in <code class="docutils literal notranslate"><span class="pre">app/schema.py</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Memory</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">max_messages</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># Trim oldest if exceeded</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_messages</span><span class="p">:]</span>
</pre></div>
</div>
<p>Key characteristics:</p>
<ul class="simple">
<li><p><strong>Bounded</strong>: Sliding window of up to 100 messages (configurable)</p></li>
<li><p><strong>Ephemeral</strong>: Lost when the process exits</p></li>
<li><p><strong>Per-agent</strong>: Each agent has its own isolated memory</p></li>
<li><p><strong>Not shared</strong>: No mechanism for inter-agent memory sharing</p></li>
<li><p><strong>Linear</strong>: Flat chronological list, no indexing or categorization</p></li>
</ul>
<section id="message-types">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Message Types</a><a class="headerlink" href="#message-types" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Message</span></code> class supports multiple roles:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">system</span></code> – System prompt messages</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user</span></code> – User input and next_step prompts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assistant</span></code> – LLM responses (text and/or tool calls)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tool</span></code> – Tool execution results</p></li>
</ul>
<p>Messages can include:</p>
<ul class="simple">
<li><p>Text content</p></li>
<li><p>Tool calls (function name + arguments)</p></li>
<li><p>Tool results (output, error, base64 images)</p></li>
<li><p>Base64-encoded images for multimodal context</p></li>
</ul>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">OpenManus</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">System Architecture</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Agent System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#class-hierarchy">Class Hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#baseagent">BaseAgent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reactagent">ReActAgent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#toolcallagent">ToolCallAgent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#manus-agent">Manus Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#browseragent">BrowserAgent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sweagent">SWEAgent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mcpagent">MCPAgent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataanalysis-agent">DataAnalysis Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sandboxmanus-agent">SandboxManus Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#agent-lifecycle">Agent Lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-system">Memory System</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="orchestration_flow.html">Orchestration Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="tool_system.html">Tool System</a></li>
<li class="toctree-l1"><a class="reference internal" href="knowledge_and_skills.html">Knowledge and Skills System</a></li>
<li class="toctree-l1"><a class="reference internal" href="llm_integration.html">LLM Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcp_integration.html">MCP Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="sandbox_system.html">Sandbox System</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="architecture.html" title="previous chapter">System Architecture</a></li>
      <li>Next: <a href="orchestration_flow.html" title="next chapter">Orchestration Flow</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, FoundationAgents.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/agent_system.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>