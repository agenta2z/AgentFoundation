<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Inter-Agent Communication &#8212; OpenClaw Technical Documentation 2026.2.23 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=54c96c00"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tool Architecture" href="tool-system.html" />
    <link rel="prev" title="Sub-agent Spawning &amp; Coordination" href="multi-agent.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="inter-agent-communication">
<span id="communication"></span><h1>Inter-Agent Communication<a class="headerlink" href="#inter-agent-communication" title="Link to this heading">¶</a></h1>
<p>This document covers the communication pathways between agents,
sessions, and the gateway.  The primary source files are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/agents/tools/sessions-send-tool.ts</span></code> – the <code class="docutils literal notranslate"><span class="pre">sessions_send</span></code>
tool implementation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/agents/pi-embedded-messaging.ts</span></code> – messaging tool detection
and classification</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/infra/agent-events.ts</span></code> – the agent event bus</p></li>
</ul>
<nav class="contents local" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#communication-pathways" id="id9">Communication Pathways</a></p></li>
<li><p><a class="reference internal" href="#gateway-rpc" id="id10">Gateway RPC</a></p></li>
<li><p><a class="reference internal" href="#session-messaging" id="id11">Session Messaging</a></p>
<ul>
<li><p><a class="reference internal" href="#the-sessions-send-tool" id="id12">The <code class="docutils literal notranslate"><span class="pre">sessions_send</span></code> Tool</a></p></li>
<li><p><a class="reference internal" href="#message-steering" id="id13">Message Steering</a></p></li>
<li><p><a class="reference internal" href="#messaging-tool-classification" id="id14">Messaging Tool Classification</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#agent-events-bus" id="id15">Agent Events Bus</a></p>
<ul>
<li><p><a class="reference internal" href="#event-payload-type" id="id16">Event Payload Type</a></p></li>
<li><p><a class="reference internal" href="#event-streams" id="id17">Event Streams</a></p></li>
<li><p><a class="reference internal" href="#emitting-events" id="id18">Emitting Events</a></p></li>
<li><p><a class="reference internal" href="#subscribing-to-events" id="id19">Subscribing to Events</a></p></li>
<li><p><a class="reference internal" href="#run-context-registry" id="id20">Run Context Registry</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#event-consumers" id="id21">Event Consumers</a></p></li>
</ul>
</nav>
<section id="communication-pathways">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Communication Pathways</a><a class="headerlink" href="#communication-pathways" title="Link to this heading">¶</a></h2>
<p>OpenClaw supports several communication pathways between agents
and sessions:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>+-----------------+     Gateway RPC     +-----------------+
|  Agent A        | ------------------&gt; |  Gateway        |
|  (session X)    | &lt;------------------ |  (process)      |
+-----------------+   agent / send /    +-----------------+
       |              sessions.patch           |
       |                                       |
       |    Agent Events Bus                   |
       +-----(in-process pub/sub)------+       |
       |                               |       |
       v                               v       v
+-----------------+             +-----------------+
|  Sub-agent B    |             |  Channel        |
|  (session Y)    |             |  Adapter        |
+-----------------+             +-----------------+
</pre></div>
</div>
</section>
<section id="gateway-rpc">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Gateway RPC</a><a class="headerlink" href="#gateway-rpc" title="Link to this heading">¶</a></h2>
<p>The primary mechanism for cross-session communication is the
<strong>gateway RPC</strong> system (<code class="docutils literal notranslate"><span class="pre">src/gateway/call.ts</span></code>).  The
<code class="docutils literal notranslate"><span class="pre">callGateway()</span></code> function sends JSON-RPC requests to the running
gateway process.</p>
<p>Key RPC methods used for communication:</p>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Gateway RPC Methods for Communication</span><a class="headerlink" href="#id1" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 75.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">agent</span></code></p></td>
<td><p>Dispatch an agent run for a session.  Used to inject messages
(including sub-agent announcements) into a session.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">send</span></code></p></td>
<td><p>Send a message directly to a channel without triggering an
agent run.  Used for direct completion delivery.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sessions.patch</span></code></p></td>
<td><p>Update session metadata (model, thinking level, spawn depth,
label).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sessions.delete</span></code></p></td>
<td><p>Delete a session and optionally its transcript.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">agent.wait</span></code></p></td>
<td><p>Wait for an agent run to complete (blocking RPC with timeout).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">chat.history</span></code></p></td>
<td><p>Retrieve conversation history for a session.</p></td>
</tr>
</tbody>
</table>
<p>Example: injecting a sub-agent announcement into the parent session:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">src/agents/subagent-announce.ts:497-510</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">await</span><span class="w"> </span><span class="nx">callGateway</span><span class="p">({</span>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;agent&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sessionKey</span><span class="o">:</span><span class="w"> </span><span class="kt">item.sessionKey</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">item.prompt</span><span class="p">,</span>
<span class="w">    </span><span class="nx">channel</span><span class="o">:</span><span class="w"> </span><span class="kt">requesterIsSubagent</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">undefined</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">origin?.channel</span><span class="p">,</span>
<span class="w">    </span><span class="nx">accountId</span><span class="o">:</span><span class="w"> </span><span class="kt">requesterIsSubagent</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">undefined</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">origin?.accountId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="kt">requesterIsSubagent</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">undefined</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">origin?.to</span><span class="p">,</span>
<span class="w">    </span><span class="nx">deliver</span><span class="o">:</span><span class="w"> </span><span class="o">!</span><span class="nx">requesterIsSubagent</span><span class="p">,</span>
<span class="w">    </span><span class="nx">idempotencyKey</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">timeoutMs</span><span class="o">:</span><span class="w"> </span><span class="kt">announceTimeoutMs</span><span class="p">,</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
</section>
<section id="session-messaging">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Session Messaging</a><a class="headerlink" href="#session-messaging" title="Link to this heading">¶</a></h2>
<section id="the-sessions-send-tool">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">sessions_send</span></code> Tool</a><a class="headerlink" href="#the-sessions-send-tool" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">sessions_send</span></code> tool allows an agent to send a text message to
another session.  This is the primary mechanism for cross-session
communication initiated by the LLM.</p>
<p>The tool is classified as a <strong>messaging tool</strong> by the detection
system in <code class="docutils literal notranslate"><span class="pre">src/agents/pi-embedded-messaging.ts</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">src/agents/pi-embedded-messaging.ts:10-11</span><a class="headerlink" href="#id3" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">CORE_MESSAGING_TOOLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">([</span>
<span class="w">  </span><span class="s2">&quot;sessions_send&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;message&quot;</span>
<span class="p">]);</span>
</pre></div>
</div>
</div>
<p>When the LLM calls <code class="docutils literal notranslate"><span class="pre">sessions_send(sessionKey,</span> <span class="pre">message)</span></code>, the tool
dispatches the message to the target session via the gateway <code class="docutils literal notranslate"><span class="pre">agent</span></code>
RPC, which triggers a new agent run in the target session’s context.</p>
</section>
<section id="message-steering">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Message Steering</a><a class="headerlink" href="#message-steering" title="Link to this heading">¶</a></h3>
<p>When a new message arrives for a session that already has an active
run, the system can <strong>steer</strong> the message into the running context
instead of queuing it:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="nx">queueEmbeddedPiMessage</span><span class="p">(</span><span class="nx">sessionId</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
</pre></div>
</div>
<p>This function (from <code class="docutils literal notranslate"><span class="pre">src/agents/pi-embedded.ts</span></code>) injects the
message into the active run’s pi-agent-core session, causing the
model to see it as a new user turn in the same conversation context.</p>
<p>Steering is used for:</p>
<ul class="simple">
<li><p>Sub-agent announcement delivery to an active parent session.</p></li>
<li><p>Follow-up user messages when queue mode is <code class="docutils literal notranslate"><span class="pre">&quot;steer&quot;</span></code>.</p></li>
<li><p>Real-time context injection during long-running tasks.</p></li>
</ul>
</section>
<section id="messaging-tool-classification">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Messaging Tool Classification</a><a class="headerlink" href="#messaging-tool-classification" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">isMessagingTool()</span></code> (<code class="docutils literal notranslate"><span class="pre">src/agents/pi-embedded-messaging.ts</span></code>:13-19)
determines whether a tool call is a messaging action:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">isMessagingTool</span><span class="p">(</span><span class="nx">toolName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">CORE_MESSAGING_TOOLS</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">toolName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">providerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalizeChannelId</span><span class="p">(</span><span class="nx">toolName</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Boolean</span><span class="p">(</span>
<span class="w">    </span><span class="nx">providerId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">getChannelPlugin</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">actions</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This classification is used to:</p>
<ul class="simple">
<li><p>Track which messages were sent via tools (to avoid duplicate
delivery).</p></li>
<li><p>Apply the <code class="docutils literal notranslate"><span class="pre">SILENT_REPLY_TOKEN</span></code> suppression when the agent
already sent its reply via a messaging tool.</p></li>
</ul>
</section>
</section>
<section id="agent-events-bus">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Agent Events Bus</a><a class="headerlink" href="#agent-events-bus" title="Link to this heading">¶</a></h2>
<p>The agent event bus (<code class="docutils literal notranslate"><span class="pre">src/infra/agent-events.ts</span></code>) is an in-process
publish-subscribe system for real-time agent activity events.</p>
<section id="event-payload-type">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Event Payload Type</a><a class="headerlink" href="#event-payload-type" title="Link to this heading">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">src/infra/agent-events.ts:3-12</span><a class="headerlink" href="#id4" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">AgentEventStream</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;lifecycle&quot;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;tool&quot;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;assistant&quot;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;error&quot;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{});</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">AgentEventPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">runId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">seq</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">          </span><span class="c1">// monotonically increasing per runId</span>
<span class="w">  </span><span class="nx">stream</span><span class="o">:</span><span class="w"> </span><span class="kt">AgentEventStream</span><span class="p">;</span>
<span class="w">  </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">           </span><span class="c1">// timestamp (Date.now())</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sessionKey?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</section>
<section id="event-streams">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Event Streams</a><a class="headerlink" href="#event-streams" title="Link to this heading">¶</a></h3>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Agent Event Streams</span><a class="headerlink" href="#id5" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Stream</p></th>
<th class="head"><p>Events</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">lifecycle</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;start&quot;</span></code> – agent run started, with <code class="docutils literal notranslate"><span class="pre">startedAt</span></code>.
<code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;end&quot;</span></code> – agent run completed, with <code class="docutils literal notranslate"><span class="pre">endedAt</span></code>.
<code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;error&quot;</span></code> – agent run failed, with error details.
<code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;fallback&quot;</span></code> – model fallback occurred.
<code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;fallback_cleared&quot;</span></code> – returned to primary model.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tool</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;start&quot;</span></code> – tool execution started, with <code class="docutils literal notranslate"><span class="pre">name</span></code>.
<code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;update&quot;</span></code> – tool execution progress.
<code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;end&quot;</span></code> – tool execution completed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">assistant</span></code></p></td>
<td><p>Text deltas from the model’s response.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">compaction</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">phase:</span> <span class="pre">&quot;end&quot;</span></code> – auto-compaction completed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">error</span></code></p></td>
<td><p>Error events from the agent runtime.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="emitting-events">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Emitting Events</a><a class="headerlink" href="#emitting-events" title="Link to this heading">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">src/infra/agent-events.ts:57-78</span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">emitAgentEvent</span><span class="p">(</span>
<span class="w">  </span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">AgentEventPayload</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;seq&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;ts&quot;</span><span class="o">&gt;</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextSeq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">seqByRun</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">runId</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="nx">seqByRun</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">runId</span><span class="p">,</span><span class="w"> </span><span class="nx">nextSeq</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// ... enrich with sessionKey from run context ...</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">listener</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">listeners</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">listener</span><span class="p">(</span><span class="nx">enriched</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Events are fire-and-forget.  Listener errors are silently caught
to prevent one subscriber from breaking others.</p>
</section>
<section id="subscribing-to-events">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Subscribing to Events</a><a class="headerlink" href="#subscribing-to-events" title="Link to this heading">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">src/infra/agent-events.ts:80-83</span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onAgentEvent</span><span class="p">(</span>
<span class="w">  </span><span class="nx">listener</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">evt</span><span class="o">:</span><span class="w"> </span><span class="kt">AgentEventPayload</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">listeners</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">listeners</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span><span class="w">  </span><span class="c1">// unsubscribe fn</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>The returned function removes the listener when called.</p>
</section>
<section id="run-context-registry">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Run Context Registry</a><a class="headerlink" href="#run-context-registry" title="Link to this heading">¶</a></h3>
<p>Each agent run can register contextual metadata that is automatically
enriched onto emitted events:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">src/infra/agent-events.ts:25-43</span><a class="headerlink" href="#id8" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">registerAgentRunContext</span><span class="p">(</span>
<span class="w">  </span><span class="nx">runId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">AgentRunContext</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">AgentRunContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sessionKey?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">verboseLevel?</span><span class="o">:</span><span class="w"> </span><span class="kt">VerboseLevel</span><span class="p">;</span>
<span class="w">  </span><span class="nx">isHeartbeat?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<p>This allows event consumers to correlate events with sessions
without the emitter needing to pass the session key every time.</p>
</section>
</section>
<section id="event-consumers">
<h2><a class="toc-backref" href="#id21" role="doc-backlink">Event Consumers</a><a class="headerlink" href="#event-consumers" title="Link to this heading">¶</a></h2>
<p>The agent event bus is consumed by several subsystems:</p>
<ol class="arabic simple">
<li><p><strong>Sub-agent registry</strong> – listens for <code class="docutils literal notranslate"><span class="pre">lifecycle</span></code> events to
detect when sub-agent runs complete and trigger the announce flow
(see <a class="reference internal" href="multi-agent.html"><span class="doc">Sub-agent Spawning &amp; Coordination</span></a>).</p></li>
<li><p><strong>Agent runner</strong> – emits <code class="docutils literal notranslate"><span class="pre">lifecycle</span></code>, <code class="docutils literal notranslate"><span class="pre">tool</span></code>, <code class="docutils literal notranslate"><span class="pre">assistant</span></code>,
and <code class="docutils literal notranslate"><span class="pre">compaction</span></code> events during the run for real-time monitoring.</p></li>
<li><p><strong>Control UI / TUI</strong> – subscribes to events for live status
display and streaming output.</p></li>
<li><p><strong>WebSocket server</strong> – forwards events to connected web clients
for real-time updates.</p></li>
<li><p><strong>Diagnostic system</strong> – records usage and performance metrics
when diagnostics are enabled.</p></li>
</ol>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">OpenClaw Technical Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Orchestration Overview</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#what-orchestration-means-in-openclaw">What “Orchestration” Means in OpenClaw</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-react-style-tool-loop">The ReAct-Style Tool Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#full-agent-pipeline">Full Agent Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#key-architectural-properties">Key Architectural Properties</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#document-map">Document Map</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="agent-definition.html">Agent Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="request-lifecycle.html">Full 13-Step Request Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="multi-agent.html">Sub-agent Spawning &amp; Coordination</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Inter-Agent Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="tool-system.html">Tool Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-handling.html">Error Recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="state-management.html">State Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="llm-integration.html">LLM Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="system-prompt.html">System Prompt</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/index.html">Knowledge System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skills/index.html">Skills System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../channels/index.html">Channel System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gateway/index.html">Gateway Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugin System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Orchestration Overview</a><ul>
      <li>Previous: <a href="multi-agent.html" title="previous chapter">Sub-agent Spawning &amp; Coordination</a></li>
      <li>Next: <a href="tool-system.html" title="next chapter">Tool Architecture</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024-2026, OpenClaw Contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/orchestration/communication.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>