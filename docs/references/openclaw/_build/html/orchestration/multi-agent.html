<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Sub-agent Spawning &amp; Coordination &#8212; OpenClaw Technical Documentation 2026.2.23 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=54c96c00"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Inter-Agent Communication" href="communication.html" />
    <link rel="prev" title="Full 13-Step Request Flow" href="request-lifecycle.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="sub-agent-spawning-coordination">
<span id="multi-agent"></span><h1>Sub-agent Spawning &amp; Coordination<a class="headerlink" href="#sub-agent-spawning-coordination" title="Link to this heading">¶</a></h1>
<p>OpenClaw supports a hierarchical multi-agent architecture where a
parent agent can spawn child sub-agents to handle specialized tasks
in parallel.  The primary source files are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/agents/subagent-spawn.ts</span></code> – spawn logic and validation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/agents/subagent-registry.ts</span></code> – run tracking and lifecycle</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/agents/subagent-announce.ts</span></code> – result announcement back
to parent</p></li>
</ul>
<nav class="contents local" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#architecture-overview" id="id8">Architecture Overview</a></p></li>
<li><p><a class="reference internal" href="#session-key-format" id="id9">Session Key Format</a></p></li>
<li><p><a class="reference internal" href="#two-spawn-modes" id="id10">Two Spawn Modes</a></p></li>
<li><p><a class="reference internal" href="#depth-and-children-limits" id="id11">Depth and Children Limits</a></p></li>
<li><p><a class="reference internal" href="#spawn-flow" id="id12">Spawn Flow</a></p></li>
<li><p><a class="reference internal" href="#agent-allowlist" id="id13">Agent Allowlist</a></p></li>
<li><p><a class="reference internal" href="#result-announcement" id="id14">Result Announcement</a></p></li>
<li><p><a class="reference internal" href="#sub-agent-registry" id="id15">Sub-agent Registry</a></p></li>
<li><p><a class="reference internal" href="#sub-agent-system-prompt" id="id16">Sub-agent System Prompt</a></p></li>
</ul>
</nav>
<section id="architecture-overview">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Architecture Overview</a><a class="headerlink" href="#architecture-overview" title="Link to this heading">¶</a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>+-------------------+
|   Main Agent      |  (depth 0)
|   session: main   |
+--------+----------+
         |
         | sessions_spawn(task=&quot;Research X&quot;)
         |
         v
+-------------------+         +-------------------+
| Sub-agent A       |         | Sub-agent B       |
| depth: 1          |         | depth: 1          |
| session: agent:   |         | session: agent:   |
|  default:subagent:|         |  default:subagent: |
|  &lt;uuid-a&gt;         |         |  &lt;uuid-b&gt;         |
+--------+----------+         +-------------------+
         |
         | (if maxSpawnDepth &gt; 1)
         v
+-------------------+
| Sub-sub-agent     |
| depth: 2          |
+-------------------+
</pre></div>
</div>
<p>The parent-child relationship is tracked by the <strong>sub-agent registry</strong>
(an in-memory <code class="docutils literal notranslate"><span class="pre">Map&lt;string,</span> <span class="pre">SubagentRunRecord&gt;</span></code> persisted to disk).
Each child run records its <code class="docutils literal notranslate"><span class="pre">requesterSessionKey</span></code> so results can be
announced back to the correct parent.</p>
</section>
<section id="session-key-format">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Session Key Format</a><a class="headerlink" href="#session-key-format" title="Link to this heading">¶</a></h2>
<p>Sub-agent sessions use a deterministic key format:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>agent:&lt;targetAgentId&gt;:subagent:&lt;uuid&gt;
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>agent:default:subagent:a1b2c3d4-e5f6-7890-abcd-ef1234567890
</pre></div>
</div>
<p>This format is constructed in <code class="docutils literal notranslate"><span class="pre">spawnSubagentDirect()</span></code>
(<code class="docutils literal notranslate"><span class="pre">src/agents/subagent-spawn.ts</span></code>:259):</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">childSessionKey</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="sb">`agent:</span><span class="si">${</span><span class="nx">targetAgentId</span><span class="si">}</span><span class="sb">:subagent:</span><span class="si">${</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">agent:</span></code> prefix enables agent ID extraction via
<code class="docutils literal notranslate"><span class="pre">resolveAgentIdFromSessionKey()</span></code>, and the <code class="docutils literal notranslate"><span class="pre">subagent:</span></code> segment
identifies the session as a sub-agent (not a regular user session).</p>
</section>
<section id="two-spawn-modes">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Two Spawn Modes</a><a class="headerlink" href="#two-spawn-modes" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">sessions_spawn</span></code> tool supports two modes, defined in
<code class="docutils literal notranslate"><span class="pre">src/agents/subagent-spawn.ts</span></code>:22-23:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">SUBAGENT_SPAWN_MODES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;session&quot;</span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Spawn Modes</span><a class="headerlink" href="#id1" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 15.0%" />
<col style="width: 15.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Mode</p></th>
<th class="head"><p>Lifecycle</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">run</span></code></p></td>
<td><p>One-shot</p></td>
<td><p>The sub-agent executes the task and terminates.  Its session
is archived (or deleted, depending on <code class="docutils literal notranslate"><span class="pre">cleanup</span></code> setting)
after the result is announced.  <strong>Default when no thread
binding is requested.</strong></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">session</span></code></p></td>
<td><p>Persistent</p></td>
<td><p>The sub-agent stays alive in a dedicated channel thread after
completing its initial task.  Users can continue interacting
with it via the thread.  <strong>Requires ``thread=true``.</strong></p></td>
</tr>
</tbody>
</table>
<p>Mode resolution logic (<code class="docutils literal notranslate"><span class="pre">resolveSpawnMode()</span></code>, line 80-89):</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">mode</span></code> is explicitly <code class="docutils literal notranslate"><span class="pre">&quot;run&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;session&quot;</span></code>, use it.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">thread=true</span></code> is requested, default to <code class="docutils literal notranslate"><span class="pre">&quot;session&quot;</span></code>.</p></li>
<li><p>Otherwise, default to <code class="docutils literal notranslate"><span class="pre">&quot;run&quot;</span></code>.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">mode=&quot;session&quot;</span></code> requires <code class="docutils literal notranslate"><span class="pre">thread=true</span></code>.  Attempting to create
a persistent session without thread binding returns an error
(line 176-180).</p>
</div>
</section>
<section id="depth-and-children-limits">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Depth and Children Limits</a><a class="headerlink" href="#depth-and-children-limits" title="Link to this heading">¶</a></h2>
<p>Two limits prevent unbounded sub-agent proliferation:</p>
<p><strong>Maximum Spawn Depth</strong></p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">src/config/agent-limits.ts:6</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">DEFAULT_SUBAGENT_MAX_SPAWN_DEPTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>The default depth of 1 means sub-agents are leaf workers – they
cannot spawn further sub-agents.  The limit is configurable via
<code class="docutils literal notranslate"><span class="pre">agents.defaults.subagents.maxSpawnDepth</span></code>.</p>
<p>Depth is checked at spawn time (<code class="docutils literal notranslate"><span class="pre">src/agents/subagent-spawn.ts</span></code>:219-227):</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">callerDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getSubagentDepthFromSessionStore</span><span class="p">(</span>
<span class="w">  </span><span class="nx">requesterInternalKey</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="p">}</span>
<span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">maxSpawnDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">agents</span><span class="o">?</span><span class="p">.</span><span class="nx">defaults</span><span class="o">?</span><span class="p">.</span><span class="nx">subagents</span><span class="o">?</span><span class="p">.</span><span class="nx">maxSpawnDepth</span>
<span class="w">  </span><span class="o">??</span><span class="w"> </span><span class="nx">DEFAULT_SUBAGENT_MAX_SPAWN_DEPTH</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">callerDepth</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">maxSpawnDepth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;forbidden&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="sb">`sessions_spawn is not allowed at this depth ...`</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Maximum Children per Agent</strong></p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">src/agents/subagent-spawn.ts:229</span><a class="headerlink" href="#id3" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">maxChildren</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">agents</span><span class="o">?</span><span class="p">.</span><span class="nx">defaults</span><span class="o">?</span><span class="p">.</span><span class="nx">subagents</span><span class="o">?</span><span class="p">.</span><span class="nx">maxChildrenPerAgent</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Each parent session can have at most 5 active child runs by default.
This prevents a single agent from overwhelming the system with
parallel tasks.</p>
</section>
<section id="spawn-flow">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Spawn Flow</a><a class="headerlink" href="#spawn-flow" title="Link to this heading">¶</a></h2>
<p>The full spawn sequence in <code class="docutils literal notranslate"><span class="pre">spawnSubagentDirect()</span></code>
(line 162-527):</p>
<ol class="arabic simple">
<li><p><strong>Validate mode</strong> – ensure <code class="docutils literal notranslate"><span class="pre">session</span></code> mode has thread binding.</p></li>
<li><p><strong>Check depth limit</strong> – compare caller depth against max.</p></li>
<li><p><strong>Check children limit</strong> – count active children.</p></li>
<li><p><strong>Validate agent allowlist</strong> – if the target agent differs from
the requester, check <code class="docutils literal notranslate"><span class="pre">subagents.allowAgents</span></code>.</p></li>
<li><p><strong>Generate child session key</strong> –
<code class="docutils literal notranslate"><span class="pre">agent:&lt;targetId&gt;:subagent:&lt;uuid&gt;</span></code>.</p></li>
<li><p><strong>Set spawn depth</strong> on child session via gateway RPC
<code class="docutils literal notranslate"><span class="pre">sessions.patch</span></code>.</p></li>
<li><p><strong>Apply model override</strong> (if specified) via <code class="docutils literal notranslate"><span class="pre">sessions.patch</span></code>.</p></li>
<li><p><strong>Apply thinking override</strong> (if specified) via <code class="docutils literal notranslate"><span class="pre">sessions.patch</span></code>.</p></li>
<li><p><strong>Bind thread</strong> (if <code class="docutils literal notranslate"><span class="pre">thread=true</span></code>) via
<code class="docutils literal notranslate"><span class="pre">ensureThreadBindingForSubagentSpawn()</span></code>.</p></li>
<li><p><strong>Build child system prompt</strong> via <code class="docutils literal notranslate"><span class="pre">buildSubagentSystemPrompt()</span></code>.</p></li>
<li><p><strong>Dispatch agent run</strong> via gateway RPC <code class="docutils literal notranslate"><span class="pre">agent</span></code> method with
<code class="docutils literal notranslate"><span class="pre">lane:</span> <span class="pre">AGENT_LANE_SUBAGENT</span></code> and <code class="docutils literal notranslate"><span class="pre">deliver:</span> <span class="pre">false</span></code>.</p></li>
<li><p><strong>Register in sub-agent registry</strong> via
<code class="docutils literal notranslate"><span class="pre">registerSubagentRun()</span></code>.</p></li>
<li><p><strong>Emit lifecycle hooks</strong> via <code class="docutils literal notranslate"><span class="pre">runSubagentSpawned()</span></code>.</p></li>
<li><p><strong>Return</strong> <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">status:</span> <span class="pre">&quot;accepted&quot;,</span> <span class="pre">childSessionKey,</span> <span class="pre">runId</span> <span class="pre">}</span></code>.</p></li>
</ol>
</section>
<section id="agent-allowlist">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Agent Allowlist</a><a class="headerlink" href="#agent-allowlist" title="Link to this heading">¶</a></h2>
<p>When a sub-agent targets a different agent ID than the requester,
the system checks the <code class="docutils literal notranslate"><span class="pre">subagents.allowAgents</span></code> configuration:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">src/agents/subagent-spawn.ts:243-258</span><a class="headerlink" href="#id4" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">allowAgents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">resolveAgentConfig</span><span class="p">(</span>
<span class="w">  </span><span class="nx">cfg</span><span class="p">,</span><span class="w"> </span><span class="nx">requesterAgentId</span>
<span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">subagents</span><span class="o">?</span><span class="p">.</span><span class="nx">allowAgents</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="p">[];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">allowAny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allowAgents</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code> allows spawning any configured agent.</p></li>
<li><p>An empty or absent list disallows cross-agent spawning.</p></li>
<li><p>Listed agent IDs are normalized to lowercase for comparison.</p></li>
</ul>
</section>
<section id="result-announcement">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Result Announcement</a><a class="headerlink" href="#result-announcement" title="Link to this heading">¶</a></h2>
<p>When a sub-agent run completes, the <strong>announce flow</strong>
(<code class="docutils literal notranslate"><span class="pre">runSubagentAnnounceFlow()</span></code> in <code class="docutils literal notranslate"><span class="pre">src/agents/subagent-announce.ts</span></code>:978-1300)
delivers the result back to the parent:</p>
<ol class="arabic simple">
<li><p><strong>Wait for completion</strong> – poll via gateway <code class="docutils literal notranslate"><span class="pre">agent.wait</span></code> RPC.</p></li>
<li><p><strong>Read output</strong> – extract the latest assistant reply from the
child session’s transcript.</p></li>
<li><p><strong>Build trigger message</strong> – format the result as a system
message including task name, status, findings, and stats.</p></li>
<li><p><strong>Resolve delivery origin</strong> – determine the channel/thread
where the announcement should be sent.</p></li>
<li><p><strong>Deliver</strong> – try steering (inject into active parent run),
queuing (enqueue for follow-up), or direct send (gateway RPC).</p></li>
<li><p><strong>Cleanup</strong> – delete the child session (if <code class="docutils literal notranslate"><span class="pre">cleanup=&quot;delete&quot;</span></code>),
or keep it for archival.</p></li>
</ol>
<p>The trigger message format:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[System Message] [sessionId: &lt;id&gt;] A subagent task &quot;&lt;label&gt;&quot;
just completed successfully.

Result:
&lt;sub-agent&#39;s final output&gt;

Stats: runtime 12s - tokens 4.2k (in 3.1k / out 1.1k)

&lt;reply instruction for parent agent&gt;
</pre></div>
</div>
</section>
<section id="sub-agent-registry">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Sub-agent Registry</a><a class="headerlink" href="#sub-agent-registry" title="Link to this heading">¶</a></h2>
<p>The registry (<code class="docutils literal notranslate"><span class="pre">src/agents/subagent-registry.ts</span></code>) maintains an
in-memory map of all active and recently completed sub-agent runs:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">src/agents/subagent-registry.ts:42</span><a class="headerlink" href="#id5" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">subagentRuns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">SubagentRunRecord</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
</div>
<p>Key operations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">registerSubagentRun()</span></code> – add a new run record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">completeSubagentRun()</span></code> – mark as ended, trigger announce flow.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">countActiveRunsForSession()</span></code> – count active children.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markSubagentRunTerminated()</span></code> – force-terminate (kill).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">listSubagentRunsForRequester()</span></code> – list children for a parent.</p></li>
</ul>
<p>The registry is persisted to disk and restored on gateway restart
via <code class="docutils literal notranslate"><span class="pre">persistSubagentRunsToDisk()</span></code> and
<code class="docutils literal notranslate"><span class="pre">restoreSubagentRunsFromDisk()</span></code>.</p>
<p>A background <strong>sweeper</strong> runs every 60 seconds to archive completed
runs after a configurable TTL
(<code class="docutils literal notranslate"><span class="pre">agents.defaults.subagents.archiveAfterMinutes</span></code>, default 60).</p>
<p>The registry listens for <code class="docutils literal notranslate"><span class="pre">lifecycle</span></code> events on the agent event bus
(see <a class="reference internal" href="communication.html"><span class="doc">Inter-Agent Communication</span></a>) to detect when sub-agent runs end:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">src/agents/subagent-registry.ts:376-416</span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="nx">listenerStop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">onAgentEvent</span><span class="p">((</span><span class="nx">evt</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">stream</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;lifecycle&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">subagentRuns</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">runId</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">entry</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Handle &quot;start&quot;, &quot;end&quot;, &quot;error&quot; phases</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
</section>
<section id="sub-agent-system-prompt">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Sub-agent System Prompt</a><a class="headerlink" href="#sub-agent-system-prompt" title="Link to this heading">¶</a></h2>
<p>Sub-agents receive a specialized system prompt
(<code class="docutils literal notranslate"><span class="pre">buildSubagentSystemPrompt()</span></code> in
<code class="docutils literal notranslate"><span class="pre">src/agents/subagent-announce.ts</span></code>:860-950) that constrains their
behavior:</p>
<ul class="simple">
<li><p>Identifies them as a sub-agent with a specific task.</p></li>
<li><p>Instructs them to stay focused and not initiate conversations.</p></li>
<li><p>Tells them their final message will auto-announce to the parent.</p></li>
<li><p>At depth &lt; maxSpawnDepth, enables further sub-agent spawning.</p></li>
<li><p>At max depth, marks them as leaf workers who cannot spawn.</p></li>
<li><p>Includes session context (label, requester session, channel).</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Example sub-agent system prompt excerpt</span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># Subagent Context

You are a **subagent** spawned by the main agent for a specific task.

## Your Role
- You were created to handle: Research the latest API changes
- Complete this task. That&#39;s your entire purpose.
- You are NOT the main agent. Don&#39;t try to be.

## Rules
1. **Stay focused** - Do your assigned task, nothing else
2. **Complete the task** - Your final message will be
   automatically reported to the main agent
...
</pre></div>
</div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">OpenClaw Technical Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Orchestration Overview</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#what-orchestration-means-in-openclaw">What “Orchestration” Means in OpenClaw</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-react-style-tool-loop">The ReAct-Style Tool Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#full-agent-pipeline">Full Agent Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#key-architectural-properties">Key Architectural Properties</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#document-map">Document Map</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="agent-definition.html">Agent Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="request-lifecycle.html">Full 13-Step Request Flow</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Sub-agent Spawning &amp; Coordination</a></li>
<li class="toctree-l3"><a class="reference internal" href="communication.html">Inter-Agent Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="tool-system.html">Tool Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-handling.html">Error Recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="state-management.html">State Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="llm-integration.html">LLM Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="system-prompt.html">System Prompt</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/index.html">Knowledge System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skills/index.html">Skills System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../channels/index.html">Channel System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gateway/index.html">Gateway Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugin System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Orchestration Overview</a><ul>
      <li>Previous: <a href="request-lifecycle.html" title="previous chapter">Full 13-Step Request Flow</a></li>
      <li>Next: <a href="communication.html" title="next chapter">Inter-Agent Communication</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024-2026, OpenClaw Contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/orchestration/multi-agent.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>